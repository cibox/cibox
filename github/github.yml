---
# This playbook should be executed using 
# ansible-playbook jenkinsbox.yml
# command
# Developed for ansible version >= 1.7
# drupal subfolder with repo_subfolder name will be prepared after execution.

- hosts: 127.0.0.1
  connection: local
  gather_facts: no

  roles:

  vars:
    repo_subfolder: DEMO # name of the future project, should be changed manually
    drupal_subfolder: docroot
    installation_profile_name: pp
    drupal_version: 7
    with_vm: True
    with_tests: True
    with_reinstall: True
    static_pull_requests_file: static_pull_requests.txt
    static_pull_requests_info: "A list of static pull requests, use branch name as identifier.\rExample:\rTask-201\rTask-210"

  pre_tasks:

  - name: Creating project folder
    shell: "mkdir {{ repo_subfolder }} || true"

  - name: Creating drupal folder
    file: path={{ repo_subfolder }}/{{ drupal_subfolder }} state=directory
    register: drupal_stat

  - name: Downloading drupal to {{ drupal_subfolder }} subfolder
    shell: "cd {{ repo_subfolder }} && drush -y --drupal-project-rename={{ drupal_subfolder }} dl drupal-{{ drupal_version }}.x"
    when: drupal_stat.changed == True
    register: drupal_dl

  - name: Inject pp profile into drupal
    file: path={{ repo_subfolder }}/{{ drupal_subfolder }}/profiles/{{ installation_profile_name }} state=directory
    register: is_profile

  - name: Copy local profile files to drupal directory
    synchronize: src=files/drupal{{ drupal_version }}/profiles/{{ installation_profile_name }}/ dest={{ repo_subfolder }}/{{ drupal_subfolder }}/profiles/{{ installation_profile_name }}/ recursive=yes archive=no
    register: profile_copy

  - name: Create a folder placeholders for sniffers
    shell: "mkdir {{ repo_subfolder }}/{{ drupal_subfolder }}/{{ item }}/"
    ignore_errors: yes
    with_items:
      - sites/all/modules/custom
      - sites/all/modules/contrib
      - sites/all/themes/custom
      - sites/all/themes/contrib
      - sites/all/modules/features

  - name: Create empty readme files for placeholders
    file: path={{ repo_subfolder }}/{{ drupal_subfolder }}/{{ item }}/readme.txt state=touch
    with_items:
      - sites/all/modules/custom
      - sites/all/modules/contrib
      - sites/all/themes/custom
      - sites/all/themes/contrib
      - sites/all/modules/features

  - name: Restrict access to YAML files
    lineinfile:
      dest: '{{ repo_subfolder }}/{{ drupal_subfolder }}/.htaccess'
      line: '# Restrict access to YAML files.\n<Files ~ "\.yml$">\n  Order Allow,Deny\n  Deny from All\n</Files>'

  - name: Injecting behat tests into repo
    synchronize: src=files/tests dest={{ repo_subfolder }}/ recursive=yes archive=no
    when: with_vm == True
    register: vmbox

  - name: Injecting vmbox into repo
    synchronize: src=files/vagrant/box/ dest={{ repo_subfolder }}/ recursive=yes archive=no
    when: with_tests == True
    register: tests

  - name: Add ansible roles to vagrant box
    synchronize: src=../roles/ dest={{ repo_subfolder }}/provisioning/ansible/roles/ recursive=yes archive=no
    when: with_vm == True
    register: vmbox

  - name: Copying installation scripts - reinstall.sh and playbook reinstall.yml
    synchronize: src=files/drupal{{ drupal_version }}/scripts/ dest={{ repo_subfolder }}/{{ drupal_subfolder }}/ recursive=yes archive=no
    when: with_reinstall == True

  - name: Setting permissions for drupal tree
    file: path={{ repo_subfolder }} state=directory mode=777 recurse=yes
    when: drupal_dl.changed == True or profile_copy.changed == True or vmbox.changed == True

  - name: Generate static pull requests file
    copy: content="{{ static_pull_requests_info }}" dest={{ repo_subfolder }}/{{ drupal_subfolder }}/devops/{{ static_pull_requests_file }}

  handlers:
